- name: Set up SSH key
  env:
    SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  run: |
    echo "$SSH_PRIVATE_KEY" > private_key
    chmod 600 private_key
    ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

- name: Deploy to Azure VM
  env:
    SERVER_USER: ${{ secrets.SSH_USERNAME }}
    SERVER_IP: ${{ secrets.SSH_HOST }}
  run: |
    ssh -o StrictHostKeyChecking=no -i private_key $SERVER_USER@$SERVER_IP << 'EOF'
      cd ~/fastapi-book-project
      git pull origin main
      source venv/bin/activate || python3 -m venv venv && source venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
      sudo systemctl restart fastapi
    EOF

